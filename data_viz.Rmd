---
title: "data_viz"
author: "Laura Menicacci"
date: "2023-03-16"
output: html_document
---

# Libraries, data
```{r setup, include=FALSE}

library(tidyverse)
library(ggthemes)
library(gridExtra)
library(packHV)

# complete dataset
df <- read_csv(".\\model_spec\\df.csv", show_col_types = FALSE)  # patent counts

```

# Descriptive plots

## Boxplot - by year
```{r, echo=FALSE,fig.height=8,fig.width=8}

df$prio_year.factor <- factor(df$prio_year)

box_plot_by_year <- ggplot(df) + # Basic box plot by year
  geom_boxplot(mapping = aes(x = prio_year.factor,
                             y = patent_count), 
               outlier.colour="red",
                outlier.size=1) +
  labs(x = "Priority filing year", y =  "Patent count") + theme_bw() + ggtitle("", subtitle = "") 

box_plot_by_year

ggsave(".\\figures\\box_plot_by_year.png", plot = box_plot_by_year, device = "png", width = 8, height = 8)

```

## Boxplot - by State
```{r, fig.height=8,fig.width=8}

box_plot_by_state <- df %>% 
  group_by(state_name) %>% 
  ggplot(aes(y = patent_count)) +
  geom_boxplot(outlier.colour="red",
               outlier.size=1) +
  facet_wrap(~state_name, scales = "free_y") +
  labs(x = "", y =  "Patent count") + 
  theme_bw() + 
  ggtitle("", subtitle = "") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

box_plot_by_state

ggsave(".\\figures\\box_plot_by_state.png", plot = box_plot_by_state, device = "png", width = 10, height = 10)

```
## Boxplot - entire distribution
```{r}
box <- df %>% 
  ggplot(aes(x = patent_count))+ 
  geom_boxplot(colour = "black") +
  xlab("")+
  ylab("") +
  theme_bw()

hist <- df %>% 
  ggplot(aes(x = patent_count)) +
  stat_bin(bins = 30, fill = "navy", colour = "black") +
  xlab("") +
  ylab("") +
  theme_bw()


box_hist_dist <- grid.arrange(box,hist, ncol=1, nrow=2, respect = FALSE, widths = c(5), heights = c(6, 6), top = "Y02E class patent counts. Total y distribution", bottom = "Dependent variable (y) = patent counts")

#hist_boxplot(df$patent_count, col = "lightblue", freq = TRUE, breaks = 20) + 

#ggsave(".\\figs_new\\box_hist_dist.png", plot = box_hist_dist, device = "png", width = 8, height = 8)

```

## Histogram & boxplot
```{r, echo=FALSE, fig.height=7,fig.width=7}

stats_pat <- df %>% # create df with stats needed: mean, median, max by state
  select(state_name, patent_count) %>% 
  group_by(state_name) %>% 
  summarise(median = median(patent_count, na.rm=TRUE), 
            mean = mean(patent_count, na.rm=TRUE), 
            q75 = quantile(patent_count, 0.75), 
            max = max(patent_count, na.rm=TRUE))

box <- stats_pat %>% 
  ggplot(aes(x = mean))+ 
  geom_boxplot(colour = "black") +
  geom_vline(xintercept = quantile(stats_pat$mean, 0.3), color = "red")+
  xlab("")+
  ylab("") +
  theme_clean() +
  theme(plot.background = element_blank(), 
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

hist <- stats_pat %>% 
  ggplot(aes(x = mean)) +
  geom_histogram(bins = 51, binwidth = 1, fill = "navy", colour = "black", alpha = 0.7) +
  geom_vline(xintercept = quantile(stats_pat$mean, 0.3), color = "red") +
  xlab("state mean patent counts") +
  ylab("") +
  theme_clean() +
  theme(plot.background = element_blank())


#box_hist_dist <- grid.arrange(box,hist, ncol=1, nrow=2, respect = FALSE, widths = c(5), heights = c(6, 6), top = "", bottom = "State mean patent counts",)

library(cowplot)
box_hist_dist <- plot_grid(box, hist, align = 'v', nrow = 2, ncol = 1) + xlab("State mean patent counts")

box_hist_dist

ggsave(".\\figures\\box_hist_means.png", plot = box_hist_dist, device = "png", width = 6, height = 6)



```


## Histogram - entire distribution
```{r}

y_dist

#ggsave(".\\fig_new\\y_distribution.png", plot = y_dist, device = "png", width = 8, height = 8)
  
```


# Non-patenting states selection

## Statistical information

Goal: selecting non-patenting US states that have such low values that they are not relevant for the analysis.
Motivation: improve fit.

```{r}
us_all <- c("Alabama", "Alaska", "Arizona", "Arkansas","California","Colorado","Connecticut", "Delaware", "Florida","Georgia","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey", "New York", "New Mexico", "North Carolina", "North Dakota","Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina","South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington","West Virginia","Wisconsin","Wyoming", "District of Columbia", "Hawaii")

stats_pat <- df %>% # create df with stats needed: mean, median, max by state
  select(state_name, patent_count) %>% 
  group_by(state_name) %>% 
  summarise(median = median(patent_count, na.rm=TRUE), 
            mean = mean(patent_count, na.rm=TRUE), 
            q75 = quantile(patent_count, 0.75), 
            max = max(patent_count, na.rm=TRUE))

stats_pat %>% ggplot(aes(x = mean)) + geom_boxplot()

stats_pat %>% ggplot(aes(x = mean)) + stat_bin(bins = 30)

```
We can observe that half of the observations - which in this case are mean value of patent count of states - fall within 


## Threshold selection

```{r}

median <- median(df$patent_count) # median of entire distribution

######################################

nonpat_median <- c() # 24 states

for (i in 1:nrow(stats_pat)){
  if (stats_pat[i, 3] <= median){  # if mean of state is less than median of entire dist: drop
    nonpat_median <- append(nonpat_median, stats_pat[[i, 1]]) 
                       }
}

##################################

q20 <- quantile(df$patent_count, 0.20)

nonpat_q20 <- c() #  states

for (i in 1:nrow(stats_pat)){
  if (stats_pat[i, 3] <= q20[[1]]){ # if mean of state is less than q20 of entire dist: drop
    nonpat_q20 <- append(nonpat_q20, stats_pat[[i, 1]]) 
                       }
}

#################################


q25 <- quantile(df$patent_count, 0.25)

nonpat_q25 <- c() #  states

for (i in 1:nrow(stats_pat)){
  if (stats_pat[i, 3] <= q25[[1]]){ # if mean of state is less than q25 of entire dist: drop
    nonpat_q25 <- append(nonpat_q25, stats_pat[[i, 1]]) 
                       }
}

#################################

q30 <- quantile(df$patent_count, 0.30)

nonpat_q30 <- c() # 15


for (i in 1:nrow(stats_pat)){
  if (stats_pat[i, 3] <= q30[[1]]){ # if mean of state is less than q30 of entire dist: drop
    nonpat_q30 <- append(nonpat_q30, stats_pat[[i, 1]]) 
                       }
}

```


# Show change in distribution when removing non-patenting states
```{r}

dist1 <- stats_pat %>% 
  ggplot(aes(x = mean)) + 
  geom_boxplot(outlier.colour="red",
               outlier.size=1) +
  theme_clean() +
  xlab("") +
  theme(plot.background = element_blank(), 
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) 
dist2 <- stats_pat %>% 
  filter(!state_name %in% nonpat_q30) %>% 
  ggplot(aes(x = mean)) + 
  geom_boxplot(outlier.colour="red",
               outlier.size=1)+
  xlab("state mean patent counts") +
  theme_clean() +
  theme(plot.background = element_blank(), 
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

change_dist <- plot_grid(dist1, dist2, align = 'v', nrow = 2, ncol = 1) + xlab("State mean patent counts")

change_dist

ggsave(".\\figures\\change_dist_means.png", plot = change_dist, device = "png", width = 6, height = 4)

```


## US STATES MAP

```{r us_map, fig.height=3, fig.width=3}
library(usmap)
library(viridis)
library(scales)

df1<- df %>% select(state_name, patent_count) %>% group_by(state_name) %>% summarise(total_count = sum(patent_count)) %>% 
  rename("state"="state_name")

map1 <- plot_usmap(data = df1, values = "total_count") + 
  scale_fill_viridis_c(option = "plasma", oob = scales::squish) + 
  theme(legend.position = "right", 
        legend.title = element_blank())
map1
#ggsave(".\\figures\\map_patent_counts.png", plot = map1, device = "png", width = 8, height = 8)


```


# 