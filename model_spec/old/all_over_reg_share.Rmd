---
title: "all over again with reg_share"
author: "Laura Menicacci"
output: html_document
---

# Libraries & data

```{r setup, echo=FALSE, show_col_types = FALSE}

library(tidyverse)
#library(tidyverse)
library(gets)
library(getspanel)
library(here)
library(doParallel)
library(readxl)
library(gdata)

pat_reg <- read_csv("D:\\PCT_EPO_counts\\patent_count_pct_direct_epo_regshare.csv", show_col_types = FALSE)

```

# Tidy data

## Add 0 values for missing years

Here I assume that years that are not present = years with no patents filed under PCT 

```{r,eval=FALSE, echo=FALSE}

years = (1977:2020)

df2 <- data.frame(matrix(ncol = 3, nrow = 0)) # create data frame with 0 rows and 3 columns

for (state in unique(pat$Up_reg_label)){ 
  for (i in (1:length(years))){
    df2 <- rbind(df2, c(state, years[i], 0))  # create empty df with state and years
  }
}
colnames(df2) <- c('Up_reg_label','prio_year','reg_share') # provide column names
for(i in (1:nrow(pat))){
  for (j in (1:nrow(df2))){
    if(pat[i,1] == df2[j,1] && pat[i,2] == df2[j,2]){ # if year is present, add patent count value to the panel
      df2[j,3] = pat[i,3] 
    }
  }
}

df2$reg_share <- as.numeric(df2$reg_share)  # transform to numeric

pat <- df2 # change to original n


pat <- pat %>% 
  rename(region = Up_reg_label) %>% 
  rename(patent_count = reg_share) 

pat$prio_year <- as.integer(pat$prio_year)

```

## Montana: change name

```{r}
for (i in 1:nrow(pat)){
  if (pat[i, 1] == "Montana (US)"){
    pat[i,1] <- "Montana"}
}
```

## Remove not regionalised patent counts 
```{r}
pat %>% 
  filter(region == "United States - not regionalised") %>% 
  summarise(across(patent_count, .fns = list(sum = sum)))

pat <- pat %>% 
  filter(region != "United States - not regionalised") 
```

## Add controls

```{r,eval=FALSE, echo=FALSE}

gdp <- read_csv("D:/Controls/SAGDP1__ALL_AREAS_1997_2021.csv", show_col_types = FALSE)

gdp_filt <- gdp %>% 
  select(!c("GeoFIPS", "Region", "TableName", "LineCode", "IndustryClassification")) %>% 
  filter(Description %in% c("Real GDP (millions of chained 2012 dollars)")) %>% # "Current-dollar GDP (millions of current dollars)"
  filter(!GeoName %in% c("United States")) %>% 
  pivot_longer(cols = c("1997", "1998", "1999","2000" ,"2001" ,"2002" ,"2003" ,"2004" ,"2005" ,"2006" ,"2007" ,"2008" ,"2009" ,"2010" ,"2011" , "2012","2013","2014","2015","2016","2017","2018","2019","2020", "2021"), 
               names_to = "year", 
               values_to = "gdp") %>% 
  select(!c("Description", "Unit")) 

gdp_filt$year <- as.numeric(gdp_filt$year)

pat_gdp <- left_join(pat, gdp_filt, by = c("region" = "GeoName", "prio_year" = "year"))

library(readxl)
pop <- read_excel("D:\\Controls\\use_oi.xlsx", sheet = 2, skip = 2)

us_codes <- as.data.frame(state.abb)

us_codes$name <- state.name

pat_codes <- left_join(pat_gdp, us_codes, by = c("region" = "name"))

for (i in 1:nrow(pat_codes)){             # add District of Columbia code
  if (pat_codes[i, 1] == "District of Columbia"){
    pat_codes[i,5] <- "DC"}
}

pop_filt <-  pop[,c(1,39:62)]

pop_long <- pop_filt %>% pivot_longer(cols = c("1997", "1998", "1999","2000" ,"2001" ,"2002" ,"2003" ,"2004" ,"2005" ,"2006" ,"2007" ,"2008" ,"2009" ,"2010" ,"2011" , "2012","2013","2014","2015","2016","2017","2018","2019","2020"), 
               names_to = "year", 
               values_to = "pop")

pop_long$year <- as.numeric(pop_long$year)

pat_gdp_pop <- left_join(pat_codes, pop_long, by = c("state.abb" = "State", "prio_year" = "year"))

pat_gdp_pop <- pat_gdp_pop %>% 
  rename("state_name"= "region") %>% 
  rename("state_code" = "state.abb") %>% 
  select(c("state_name", "state_code", "prio_year", "patent_count", "gdp", "pop"))

library(janitor)

state_name <- c("alabama", "alaska", "arizona", "arkansas","california","colorado","connecticut","delaware","florida","georgia", "idaho","illinois","indiana","iowa","kansas","kentucky","louisiana","maine","maryland","massachusetts","michigan","minnesota","mississippi","missouri","montana","nebraska","nevada","new_hampshire","new_Jersey","new_mexico", "new_york", "north_carolina","north_dakota","ohio", "oklahoma","oregon","pennsylvania","rhode_island","south_carolina",
"south_dakota", "tennessee","texas","utah","vermont","virginia","washington","west_virginia","wisconsin","wyoming", "district_of_columbia")

csv <- c()
df1 <- data.frame(matrix(ncol = 3, nrow = 0))
avg_temp <- data.frame()

for (i in state_name){
  csv <- read_csv(paste0('D:\\Controls\\avg_temp\\1999-2021_',i,'.csv')) # read csv w i = name of state
  df <- csv[-c(1:3),1:2]  # select specific rows and cols
  
  df1 <- df %>% 
    row_to_names(row_number = 1) # 1 row to colname 
  
  df1$Date <-substr(df1$Date,1,nchar(df1$Date)-2) # remove last 2 digits of year var
  
  df1$State <- i # add column w state name 
  
  avg_temp <- rbind(avg_temp, df1) # append dataframe
}

avg_temp$State <- avg_temp$State %>% 
  str_replace_all("_", " ") %>%  # change names with _ with " 
  str_to_title() # put first case high

for (i in 1:nrow(avg_temp)){ # correct district of columbia  
  if (avg_temp[i, 3] == "District Of Columbia"){
    avg_temp[i, 3] <- "District of Columbia"
  }
}

# hawaii

hawaii <- read_csv('D:\\Controls\\honolulu_area_avg_temp.csv')

hawaii <- hawaii %>% 
  mutate(State = "Hawaii") %>% 
  rename("Date" = "Year") %>% 
  rename("Value" = "Annual")

avg_temp_all <- rbind(avg_temp, hawaii)

avg_temp_all$Date <- as.integer(avg_temp_all$Date)

# join with all data

pat_gdp_pop_temp <- left_join(pat_gdp_pop, avg_temp_all, by = c("state_name" = "State", "prio_year" = "Date"))

df <- pat_gdp_pop_temp %>% 
  filter(prio_year >= 1999 & prio_year <= 2020) %>% 
  rename("avg_temp" = "Value")

```

## Complete dataset 

```{r}
df %>% filter(!complete.cases(.)) 

write_csv(df,"D:\\For_model\\final_df_regshare.csv")
```

# Model specifications

```{r}
dfx <- read_csv("D:\\For_model\\final_df_regshare.csv", show_col_types = FALSE)

dfx2 <- df_ri_ok %>% 
  mutate(lpop = log(pop),
         lgdp = log(gdp),
         lgdp_sq = log(gdp)^2,
         ltemp = log(avg_temp),
         ihs_patent_count = asinh(patent_count), # inverse hyperbolic sine transformation
         log_patent_count = log(patent_count)) %>% # log transformation
  filter(prio_year >= 2000 & prio_year < 2020)

```

## Samples

```{r}
us_all <- c("Alabama", "Alaska", "Arizona", "Arkansas","California","Colorado","Connecticut", "Delaware", "Florida","Georgia","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey", "New York", "New Mexico", "North Carolina", "North Dakota","Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina","South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington","West Virginia","Wisconsin","Wyoming", "District of Columbia", "Hawaii")

us_q20 <- c("Alabama", "Arizona", "Arkansas","California","Colorado","Connecticut", "Delaware", "Florida","Georgia","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Missouri","Nebraska","Nevada","New Hampshire","New Jersey", "New York", "New Mexico", "North Carolina", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina","South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington","Wisconsin", "District of Columbia", "Hawaii")

us_q25 <- c("Alabama", "Arizona", "California","Colorado","Connecticut", "Delaware", "Florida","Georgia","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Missouri","Nevada","New Hampshire","New Jersey", "New York", "New Mexico", "North Carolina", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina","South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington","Wisconsin", "District of Columbia", "Hawaii")

us_q30 <- c( "Arizona","California","Colorado","Connecticut", "Delaware", "Florida","Georgia","Idaho","Illinois","Indiana","Iowa","Kentucky","Maryland","Massachusetts","Michigan","Minnesota","Missouri","Nevada","New Hampshire","New Jersey", "New York", "New Mexico", "North Carolina", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "Tennessee", "Texas", "Utah","Virginia", "Washington","Wisconsin", "District of Columbia")

samples <- mget(c("us_all", "us_q20", "us_q25", "us_q30"))

```

# Run model

## Functional forms
```{r}
controls <- c(" ~ lgdp + lpop + lgdp_sq") 

dep_var <- c("log_patent_count") 

base_forms <- paste0(rep(dep_var, each = length(controls)), controls)

base_forms
```


```{r}

cl <- makeCluster(3)
registerDoParallel(cl)

models <- foreach(f = base_forms, .combine = rbind, .packages = c('tidyverse', 'getspanel')) %:%
  foreach(smpl = c("us_q30"), .combine = rbind) %:%
  foreach(a = c(0,1), .combine = rbind) %:%
  #foreach(b = c(10, 20, 30), .combine = rbind) %:%
  foreach(p.value = c(0.01), .combine = rbind, .errorhandling = "remove") %dopar% {
    dat <- dfx2 %>% filter(state_name %in% samples[[smpl]])
      is <- isatpanel(
            data = dat,
            formula = as.formula(f),
            index = c("state_name", "prio_year"),
            effect = "twoways",
            iis = FALSE,
            fesis = TRUE,
            ar = a,
            t.pval = p.value,
            max.block.size = 20
            )
          models = tibble(source = f, 
                          state_sample = smpl,      
                          year_range = paste0(min(dfx2$prio_year),":",max(dfx2$prio_year)),
                          p_val = p.value, 
                          is = list(is),
                          iis = FALSE,
                          b_size = 20,
                          ar = a)
  }

stopCluster(cl)

saveRDS(models, ".\\results\\models_main_allshares_NOIIS.RDS")

```

# Visualize data

```{r, fig.height=8, fig.width=8}

dfx <- read_csv("D:\\For_model\\final_df_regshare.csv", show_col_types = FALSE)

box_plot_by_state <- dfx %>% 
  group_by(state_name) %>% 
  ggplot(aes(y = patent_count)) +
  geom_boxplot(outlier.colour="red",
               outlier.size=1) +
  facet_wrap(~state_name, scales = "free_y") +
  labs(x = "", y =  "Patent count") + 
  theme_bw() + 
  ggtitle("International US patent counts (Y02E class)", subtitle = "Distribution by State") 

box_plot_by_state
```



```{r, fig.height=8, fig.width=8}

stats_pat <- dfx %>% # create df with stats needed: mean, median, max by state
  select(state_name, patent_count) %>% 
  group_by(state_name) %>% 
  summarise(median = median(patent_count, na.rm=TRUE), 
            mean = mean(patent_count, na.rm=TRUE), 
            q75 = quantile(patent_count, 0.75), 
            max = max(patent_count, na.rm=TRUE))

box <- stats_pat %>% 
  ggplot(aes(x = mean))+ 
  geom_boxplot(colour = "black") +
  xlab("")+
  ylab("") +
  theme_bw()

hist <- stats_pat %>% 
  ggplot(aes(x = mean)) +
  geom_histogram(bins = 51, fill = "navy", colour = "black") +
  xlab("") +
  ylab("") +
  theme_bw()


box_hist_dist <- grid.arrange(box,hist, ncol=1, nrow=2, respect = FALSE, widths = c(5), heights = c(6, 6), top = "Y02E class patent counts. State mean distribution ", bottom = "State mean patent counts")

```

## Time series

```{r, fig.height=8, fig.width=8}
pat_all_series <- dfx %>% 
  group_by(state_name) %>% 
  ggplot(aes(x = prio_year, y = patent_count)) + 
  geom_line(linewidth = 0.5, colour = "navy") + 
  facet_wrap(~state_name) + 
  theme_minimal() + 
  labs(x = "Priority year", y = "Patent count") +
  ggtitle("Total patent counts by US State (Y02E class)", subtitle = "PCT and direct EPO aggregation")

pat_all_series
```

## Analysis models

```{r, fig.height=7, fig.width=7}

situa <- readRDS(".\\results\\models_main_allshares.RDS")

plot(situa$is[[1]])

situa$is[[1]]
```


## Analysis models no IIS

```{r, fig.height=7, fig.width=7}

situa_noiis <- readRDS(".\\results\\models_main_allshares_NOIIS.RDS")

plot(situa_noiis$is[[1]])
```


# build new statistics: inv_share x reg_share

```{r}

reg <- read_csv("D:\\For_model\\final_df_regshare.csv") %>% 
  select(state_name, prio_year, patent_count)

df_ri <- left_join(df2, reg, by = c("state_name", "prio_year"))

df_ri_ok <- df_ri %>% 
  mutate(patent_count = patent_count.x*patent_count.y)

```

