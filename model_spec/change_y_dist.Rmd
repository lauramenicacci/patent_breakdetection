---
title: "plot distributions"
author: "Laura Menicacci"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---
# Libraries

```{r, echo=FALSE}
library(tidyverse)
library(gets)
library(getspanel)
library(here)
library(doParallel)
library(readxl)
```

# Data & controls 
```{r, echo=FALSE}

df <- read_csv(".\\model_spec\\df.csv", show_col_types = FALSE)

```

# Descriptive statistics 

## Summary statistics

```{r, echo=FALSE}
library(psych)

describe(df)
```



## Distributions

### Levels distribution
```{r}

df %>% 
  ggplot(aes(x = patent_count)) + geom_histogram(fill= "lightblue", colour = "black") + theme_bw()

```
### Distribution with natural log transformation

```{r}
df %>% 
  ggplot(aes(x = log_patent_count)) + geom_histogram(fill = "lightblue", colour = "black") + theme_bw()

```
### Distribution with inverse hyperbolic sine transformation
```{r}

# inverse hyperbolic sine function
ihs <- function(x) {
    y <- log(x + sqrt(x ^ 2 + 1))
    return(y)
}


df2 <- df %>% mutate(ihs_patent_count = asinh(patent_count)) # doublecheck with built-in function

df2 %>% 
  ggplot(aes(x = ihs_patent_count)) + geom_histogram(fill = "lightblue", colour = "black") + theme_bw()


```


# Play around w model & y transformations

## Functional forms

```{r}
controls <- c(" ~ gdp + pop + avg_temp + fuel") 

dep_var <- c( "patent_count", "log_patent_count", "ihs_patent_count") 

base_forms <- paste0(rep(dep_var, each = length(controls)), controls)

base_forms
```


```{r, echo=FALSE, eval=FALSE}

cl <- makeCluster(4)
registerDoParallel(cl)

models <- foreach(f = base_forms, .combine = rbind, .packages = c('tidyverse', 'getspanel')) %:%
  foreach(a = c(0,1), .combine = rbind) %:%
  #foreach(b = c(10, 20, 30), .combine = rbind) %:%
  foreach(p.value = c(0.01, 0.001), .combine = rbind, .errorhandling = "remove") %dopar% {
      is <- isatpanel(
            data = df2,
            formula = as.formula(f),
            index = c("state_name", "prio_year"),
            effect = "twoways",
            iis = TRUE,
            fesis = TRUE,
            ar = a,
            t.pval = p.value,
            max.block.size = 20
            )
          models = tibble(source = f, 
                          year_range = paste0(min(df2$prio_year),":",max(df2$prio_year)), 
                          p_val = p.value, 
                          is = list(is),
                          iis = TRUE,
                          b_size = 20,
                          ar = a)
  }

saveRDS(models, ".\\levels_y_transformations.RDS")

```


## have a look
```{r}

levels_y_trans <- readRDS(".\\levels_y_transformations.RDS")

levels_y_trans

```
## tables
```{r}
for (i in 1:nrow(levels_y_trans)){
  print(levels_y_trans$is[[i]])
}
```


## plot
```{r}

plot(levels_y_trans$is[[1]])

plot(levels_y_trans$is[[2]])

plot(levels_y_trans$is[[3]])

plot(levels_y_trans$is[[4]])

plot(levels_y_trans$is[[5]])

plot(levels_y_trans$is[[6]])

plot(levels_y_trans$is[[7]])

plot(levels_y_trans$is[[8]])


```

## Try with logged y & removing 37 obs w inf values

```{r}
df_log_noinf <- df2 %>% 
  filter(!(log_patent_count == "-Inf"))

controls <- c(" ~ gdp + pop + avg_temp + fuel") 

dep_var <- c( "log_patent_count") 

base_forms <- paste0(rep(dep_var, each = length(controls)), controls)

cl <- makeCluster(4)
registerDoParallel(cl)

models_noinf <- foreach(f = base_forms, .combine = rbind, .packages = c('tidyverse', 'getspanel')) %:%
  foreach(a = c(0,1), .combine = rbind) %:%
  #foreach(b = c(10, 20, 30), .combine = rbind) %:%
  foreach(p.value = c(0.01, 0.001), .combine = rbind, .errorhandling = "remove") %dopar% {
      is <- isatpanel(
            data = df_log_noinf,
            formula = as.formula(f),
            index = c("state_name", "prio_year"),
            effect = "twoways",
            iis = TRUE,
            fesis = TRUE,
            ar = a,
            t.pval = p.value,
            max.block.size = 20
            )
          models_noinf = tibble(source = f, 
                          year_range = paste0(min(df_log_noinf$prio_year),":",max(df_log_noinf$prio_year)), 
                          p_val = p.value, 
                          is = list(is),
                          iis = TRUE,
                          b_size = 20,
                          ar = a)
}


mod_log_noinf <- saveRDS(models_noinf, ".\\log_mod_noinf.RDS")

```


```{r}

plot(models_noinf$is[[1]])

plot(models_noinf$is[[2]])

plot(models_noinf$is[[3]])

plot(models_noinf$is[[4]])

```


```{r}
plot_residuals(models_noinf$is[[1]])

plot_residuals(models_noinf$is[[2]])

plot_residuals(models_noinf$is[[3]])

plot_residuals(models_noinf$is[[4]])
```

## Tabset Multiple Results Manually {.tabset}

Tabset manually by setting {.tabset} at the level above where you want your tabs to appear. Each code chunk to be displayed as a tab requires one more # sign in its title but no {.tabset} if it is the last level of tabs. You can specify which tab you wish to be displayed automatically by specifying {.active} in its chunk title.

Model results used below are run using isatpanel. The RMarkdown script includes the code (commented out) used to run the models but uses the saved dataframes of model results to reduce run time of RMarkdown document.

### TRY OUT TABSETTING 
```{r}

library(grid)
library(gridExtra)

# Plotting functions

f <- function(k) {
        step <- k
        function(y) seq(floor(min(y)), ceiling(max(y)), by = step)
}

# Arranges result plots (plot and plot_grid) and prints model results
# Option to suppress model results using results = FALSE is required for automatic tabsetting.
gen_p <- function(df, results = TRUE){
  if(nrow(df) == 0){return("Empty data frame. Model likely not run.")}else{
    for(i in 1:nrow(df)){
      mt <- paste0(df$country_sample[i], " (", df$year_range[i],")", "; p.value: ",df$p_val[i],  "; AR: ",df$ar[i])
      st <- paste0("Formula: ", df$form[i])
      
    res <- df %>% slice(i) %>% pull(is) %>% first
  
    pl <- res %>% 
      plot(zero_line = FALSE) +
        ggtitle(label = mt, subtitle = st) +
      scale_x_continuous(breaks = f(10))
    
    pg <- res %>%
      plot_grid() +
      ggtitle(label = mt, subtitle = st)
    grid.arrange(pl, pg, ncol = 2)

    if(results == TRUE){
        print(st)
        print(mt)
        print(res)
      }
    }
  }
}

```


### Model 1 {.tabset}
#### 1990-2018 {.tabset}
##### AR = 0
```{r, echo = FALSE}
models <- readRDS(".\\levels_y_transformations.RDS")

models %>% filter(source == "patent_count ~ gdp + pop + avg_temp + fuel" & year_range == "2000:2020" & ar == 0 & p_val == "0.01") %>% gen_p(.)

```

##### AR = 1
```{r, echo = FALSE}

mods %>% filter(mod_name == "Model 1" & year_range == "1990:2018" & ar == 1) %>% gen_p(.)

```

#### 2000-2018 {.tabset}
##### AR = 0
```{r, echo = FALSE}

mods %>% filter(mod_name == "Model 1" & year_range == "2000:2018" & ar == 0) %>% gen_p(.)

```

##### AR = 1
```{r, echo = FALSE}

mods %>% filter(mod_name == "Model 1" & year_range == "2000:2018" & ar == 1) %>% gen_p(.)

```

### Model 2 {.tabset}
#### 1990-2018 {.tabset}
##### AR = 0
```{r, echo = FALSE}

mods %>% filter(mod_name == "Model 2" & year_range == "1990:2018" & ar == 0) %>% gen_p(.)

```

##### AR = 1
```{r, echo = FALSE}

mods %>% filter(mod_name == "Model 2" & year_range == "1990:2018" & ar == 1) %>% gen_p(.)

```

#### 2000-2018 {.tabset}
##### AR = 0
```{r, echo = FALSE}

mods %>% filter(mod_name == "Model 2" & year_range == "2000:2018" & ar == 0) %>% gen_p(.)

```

##### AR = 1
```{r, echo = FALSE}

mods %>% filter(mod_name == "Model 2" & year_range == "2000:2018" & ar == 1) %>% gen_p(.)

```