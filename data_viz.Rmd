---
title: "data_viz"
author: "Laura Menicacci"
date: "2023-03-16"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(gridExtra)
library(packHV)

df <- read_csv(".\\model_spec\\df.csv")
```

# Descriptive plots

## Boxplot - by year
```{r, echo=FALSE,fig.height=8,fig.width=8}
# Basic box plot

df$prio_year.factor <- factor(df$prio_year)

box_plot_by_year <- ggplot(df) + 
  geom_boxplot(mapping = aes(x = prio_year.factor,
                             y = patent_count), 
               outlier.colour="red",
                outlier.size=1) +
  labs(x = "Priority filing year", y =  "Patent count") + theme_bw() + ggtitle("International US patent counts (Y02E class)", subtitle = "Distribution over time") 

box_plot_by_year

ggsave(".\\fig_new\\box_plot_by_year.png", plot = box_plot_by_year, device = "png", width = 10, height = 10)

```

## Boxplot - by State
```{r, fig.height=8,fig.width=8}

box_plot_by_state <- df %>% 
  group_by(state_name) %>% 
  ggplot(aes(y = patent_count)) +
  geom_boxplot(outlier.colour="red",
               outlier.size=1) +
  facet_wrap(~state_name, scales = "free_y") +
  labs(x = "", y =  "Patent count") + 
  theme_bw() + 
  ggtitle("International US patent counts (Y02E class)", subtitle = "Distribution by State") 

box_plot_by_state

#ggsave(".\\figs_new\\box_plot_by_state.png", plot = box_plot_by_state, device = "png", width = 10, height = 10)

```
## Boxplot - entire distribution
```{r}
box <- df %>% 
  ggplot(aes(x = patent_count))+ 
  geom_boxplot(colour = "black") +
  xlab("")+
  ylab("") +
  theme_bw()

hist <- df %>% 
  ggplot(aes(x = patent_count)) +
  stat_bin(bins = 30, fill = "navy", colour = "black") +
  xlab("") +
  ylab("") +
  theme_bw()


box_hist_dist <- grid.arrange(box,hist, ncol=1, nrow=2, respect = FALSE, widths = c(5), heights = c(6, 6), top = "Y02E class patent counts. Total y distribution", bottom = "Dependent variable (y) = patent counts")

#hist_boxplot(df$patent_count, col = "lightblue", freq = TRUE, breaks = 20) + 

ggsave(".\\figs_new\\box_hist_dist.png", plot = box_hist_dist, device = "png", width = 8, height = 8)

```

## Histogram - entire distribution
```{r}


y_dist

#ggsave(".\\fig_new\\y_distribution.png", plot = y_dist, device = "png", width = 8, height = 8)
  
```


# Non-patenting states selection

## Statistical information

Goal: selecting non-patenting US states that have such low values that they are not relevant for the analysis.
Motivation: improve fit.

```{r}
us_all <- c("Alabama", "Alaska", "Arizona", "Arkansas","California","Colorado","Connecticut", "Delaware", "Florida","Georgia","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey", "New York", "New Mexico", "North Carolina", "North Dakota","Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina","South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington","West Virginia","Wisconsin","Wyoming", "District of Columbia", "Hawaii")

stats_pat <- df %>% # create df with stats needed: mean, median, max by state
  select(state_name, patent_count) %>% 
  group_by(state_name) %>% 
  summarise(median = median(patent_count, na.rm=TRUE), 
            mean = mean(patent_count, na.rm=TRUE), 
            q75 = quantile(patent_count, 0.75), 
            max = max(patent_count, na.rm=TRUE))

stats_pat %>% ggplot(aes(x = mean)) + geom_boxplot()

stats_pat %>% ggplot(aes(x = mean)) + stat_bin(bins = 30)

```
We can observe that half of the observations - which in this case are mean value of patent count of states - fall within 


## Threshold selection

```{r}

median <- median(df$patent_count) # median of entire distribution

######################################

nonpat_median <- c() # 24 states

for (i in 1:nrow(stats_pat)){
  if (stats_pat[i, 3] <= median){  # if mean of state is less than median of entire dist: drop
    nonpat_median <- append(nonpat_median, stats_pat[[i, 1]]) 
                       }
}

##################################

q20 <- quantile(df$patent_count, 0.20)

nonpat_q20 <- c() #  states

for (i in 1:nrow(stats_pat)){
  if (stats_pat[i, 3] <= q20[[1]]){ # if mean of state is less than q20 of entire dist: drop
    nonpat_q20 <- append(nonpat_q20, stats_pat[[i, 1]]) 
                       }
}

#################################


q25 <- quantile(df$patent_count, 0.25)

nonpat_q25 <- c() #  states

for (i in 1:nrow(stats_pat)){
  if (stats_pat[i, 3] <= q25[[1]]){ # if mean of state is less than q25 of entire dist: drop
    nonpat_q25 <- append(nonpat_q25, stats_pat[[i, 1]]) 
                       }
}

#################################

q30 <- quantile(df$patent_count, 0.30)

nonpat_q30 <- c() # 15


for (i in 1:nrow(stats_pat)){
  if (stats_pat[i, 3] <= q30[[1]]){ # if mean of state is less than q30 of entire dist: drop
    nonpat_q30 <- append(nonpat_q30, stats_pat[[i, 1]]) 
                       }
}

```

```{r}

stats_pat %>% 
  ggplot(aes(x = mean)) + 
  geom_boxplot()

stats_pat %>% 
  filter(!state_name %in% nonpat_q20) %>% 
  ggplot(aes(x = mean)) + 
  geom_boxplot()

stats_pat %>% 
  filter(!state_name %in% nonpat_q25) %>% 
  ggplot(aes(x = mean)) + 
  geom_boxplot()

stats_pat %>% 
  filter(!state_name %in% nonpat_q30) %>% 
  ggplot(aes(x = mean)) + 
  geom_boxplot()

```



