---
title: "New results"
author: "Laura Menicacci"
date: "`r Sys.Date()`"
output: html_document
---

```{r set-options, echo=FALSE, cache=FALSE}
options(width = 3000)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, max.height = '300px', fig.width = 16, fig.height = 8) #fig.show="hold",,

library(data.table)
library(tidyverse)
library(openxlsx)
library(gets)
library(getspanel)
library(here)
library(doParallel)
library(gridExtra)
library(conflicted)
library(viridis)
#library(gplots)

conflict_prefer("filter", "dplyr")
conflict_prefer("first", "dplyr")
conflict_prefer("lag", "dplyr")

# mod prep
new_results <- readRDS(here("model_spec/results/models_nonpat.RDS")) %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula),
         mod_name = case_when(grepl("ihs", source) & grepl("gdp", source) ~ "Level controls",
                              !grepl("ihs", source) & grepl("lgdp", source) ~ "Log controls",
                              grepl("ihs", source) & grepl("lgdp", source) ~ "Log controls",
                              !grepl("ihs", source) & grepl("gdp", source) ~ "Level controls"))
  
new_results

```

# Data description

```{r, echo = FALSE, fig.height=8,fig.width=8}

df <- read_csv(".\\model_spec\\df.csv")

box_plot_by_state <- df %>% 
  group_by(state_name) %>% 
  ggplot(aes(y = patent_count)) +
  geom_boxplot(outlier.colour="red",
               outlier.size=1) +
  facet_wrap(~state_name, scales = "free_y") +
  labs(x = "Priority filing year", y =  "Patent count") + 
  theme_bw() + 
  ggtitle("International US patent counts (Y02E class)", subtitle = "Distribution by State") 

box_plot_by_state

df %>% 
  ggplot(aes(x = patent_count))+ 
  geom_boxplot()

```

# State choice

Removed non-patenting states. Created two samples following two criteria:
 * "Visual" method: plotted distribution by state and removed all states that had overall total patenting equal or less than 5, so very few counts overall. 5 states fell into this criteria.
 The removed states are the following:
 - Alaska
 - Mississippi
 - North Dakota 
 - West Virginia
 - Wyoming
 
Rmk: there are still very low patenting states (e.g. Nebraska, Arkansas, Maine, Louisiana, Kansas, Hawaii)

 * Mechanical method: selected states whose distribution fell entirely below the median of y. 13 states fell into this criteria 
 The removed states are the following:
 - "Alabama" 
 - "Alaska"
 - "District of Columbia" 
 - "Kansas"      
 - "Kentucky"  
 - "Louisiana" 
 - "Maine"  
 - "Mississippi"  
 - "Montana"
 - "Nebraska"   
 - "North Dakota"   
 - "West Virginia" 
 - "Wyoming"             

```{r, include = FALSE}
# Plotting functions

f <- function(k) {
  step <- k
  function(y) seq(floor(min(y)), ceiling(max(y)), by = step)
}

# Arranges result plots (plot and plot_grid) and prints model results
# Option to suppress model results using results = FALSE is required for automatic tabsetting.
gen_p <- function(df, results = TRUE, auto = FALSE){
  if(nrow(df) == 0){return("Empty data frame. Model likely not run.")}else{
    for(i in 1:nrow(df)){
      mt <- paste0(df$state_sample[i], " (", df$year_range[i],")", "; p.value: ",df$p_val[i],  "; AR: ",df$ar[i])
      st <- paste0("Formula: ", df$source[i])
      
      res <- df %>% slice(i) %>% pull(is) %>% first
      
      pl <- res %>% 
        plot(zero_line = FALSE) +
        ggtitle(label = mt, subtitle = st) +
        scale_x_continuous(breaks = f(10))
      
      pg <- res %>%
        plot_grid() +
        ggtitle(label = mt, subtitle = st)
      grid.arrange(pl, pg, ncol = 2)
      
      if(results == TRUE & auto == FALSE){
        print(st)
        print(mt)
        print(res)
      }else if(results == TRUE & auto == TRUE){
        p <- invisible(capture.output(res$isatpanel.result))
        # Spacing included to trick knitr into reading as verbatim code.
        cat(c("                         \n", 
              "                         \n", 
              paste("                  ", st,'     \n'),
              paste("                  ", mt,'     \n'),
              paste("                  ", p,'     \n')))
      }
    }
  }
}
```


# Overview: Preliminary results {.tabset}

Model specifications:
 * AR(0,1)
 * y with ihs transformation, y with log+1 transformation, normal y
 * p-value = 0.01, 0.05

Best fit to me: patent_count with logs, AR = 1 

## AR0 {.tabset}
```{r prelim, echo = FALSE, results = 'asis', cache = TRUE}

 new_results %>%
  filter(ar == 0) %>% 
       dplyr::group_split(dep) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$dep)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$p_val)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$state_sample)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, state_sample == sm & p_val == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })

```
## AR1 {.tabset}

```{r}

new_results %>%
  filter(ar == 1) %>% 
       dplyr::group_split(dep) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$dep)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$p_val)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$state_sample)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, state_sample == sm & p_val == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })

```



